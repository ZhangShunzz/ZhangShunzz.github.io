---
layout: post
title: "Mysql：主从不同步故障"
author: "zhangshun"
header-img: "img/background/11.jpg"
header-mask: 0.2
tags:
  - Mysql
---

### 前言

今早晨看告警信息时发现，两台数据库主从断开了，我差点人没了<br>
登录服务器，`show slave status\G;`<br>
DB01:
```
mysql> show slave status\G;
					...... 
                   Last_Errno: 1062
                   Last_Error: Could not execute Write_rows event on table zeus.xinyan_cache; Duplicate entry 'b98e4fab203607559fc5347b60cb64a41cf50a79650fbda3a1a4be5a1cfd16d9' for key 'PRIMARY', Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event's master log mysql2-bin.000006, end_log_pos 560082858
					......
```
DB02:
```
MySQL [zeus]> show slave status\G;
					...... 
                   Last_Errno: 1062
                   Last_Error: Could not execute Write_rows event on table zeus.xinyan_cache; Duplicate entry 'b98e4fab203607559fc5347b60cb64a41cf50a79650fbda3a1a4be5a1cfd16d9' for key 'PRIMARY', Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event's master log mysql1-bin.000001, end_log_pos 10867425
					......
```

两台数据库做的双主架构，可以看出：<br>
DB01在同步DB02二进制日志的**560082858**位置时发生了1062主键冲突的报错<br>
DB02在同步DB01二进制日志的**10867425**位置时发生了1062主键冲突的报错<br>

查看mysql的error.log
```
2019-10-29T03:29:51.885616+08:00 11 [ERROR] Slave SQL for channel '': Could not execute Write_rows event on table zeus.xinyan_cache; Duplicate entry 'b98e4fab203607559fc5347b60cb64a41cf50a79650fbda3a1a4be5a1cfd16d9' for key 'PRIMARY', Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event's master log mysql2-bin.000006, end_log_pos 560082858, Error_code: 1062
2019-10-29T03:29:51.885651+08:00 11 [Warning] Slave: Duplicate entry 'b98e4fab203607559fc5347b60cb64a41cf50a79650fbda3a1a4be5a1cfd16d9' for key 'PRIMARY' Error_code: 1062
2019-10-29T03:29:51.885662+08:00 11 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread with "SLAVE START". We stopped at log 'mysql2-bin.000006' position 560082351
```

### mysqlbinlog

使用mysqlbinlog来确定具体出错的sql，于是
